<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criminal Records</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            color: #2c3e50;
            margin: 10px 0 20px;
            font-size: 1.8rem;
            text-align: center;
        }
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .add-btn, .export-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            flex: 1;
            min-width: 150px;
            text-align: center;
            transition: background 0.3s;
        }
        .add-btn:hover, .export-btn:hover {
            opacity: 0.9;
        }
        .export-btn {
            background: #27ae60;
        }
        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            flex: 1;
            min-width: 180px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #2c3e50;
            font-weight: bold;
        }
        .filter-group select, 
        .filter-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        .search-container input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
            font-size: 14px;
            min-width: 0;
        }
        .search-container button {
            padding: 10px 15px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 100px;
            transition: background 0.3s;
        }
        .search-container button:hover {
            background: #1a252f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 10px;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
            font-size: 13px;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .photo-cell {
            width: 70px;
        }
        .photo-cell img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-cell img:hover {
            transform: scale(1.05);
        }
        .action-btns {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .action-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            transition: opacity 0.3s;
        }
        .action-btn:hover {
            opacity: 0.9;
        }
        .view-btn {
            background: #3498db;
            color: white;
        }
        .edit-btn {
            background: #f39c12;
            color: white;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        .age-badge {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
            display: inline-block;
        }
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 16px;
        }
        .reset-filters {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: auto;
            transition: background 0.3s;
        }
        .reset-filters:hover {
            background: #6c7a7d;
        }
        
        /* Modal for enlarged photo */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }
        .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border: 3px solid white;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .close-modal {
            color: white;
            font-size: 30px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
            background: #e74c3c;
            padding: 5px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .close-modal:hover {
            background: #c0392b;
        }
        
        /* Responsive table styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .photo-cell img {
                width: 50px;
                height: 50px;
            }
            
            th, td {
                padding: 6px 8px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 600px) {
            table {
                display: block;
                overflow-x: auto;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .photo-cell img {
                width: 40px;
                height: 40px;
            }
        }
        
        @media (max-width: 480px) {
            .button-group {
                flex-direction: column;
            }
            
            .add-btn, .export-btn {
                width: 100%;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-container button {
                width: 100%;
            }
            
            .reset-filters {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Criminal Records</h1>
        <div class="button-group">
            <a href="criminal-form.html" class="add-btn">Add New Criminal</a>
            <button class="export-btn" onclick="exportToPDF()">Export to PDF</button>
        </div>
        
        <div class="filter-container">
            <div class="filter-group">
                <label for="ageFilter">Age Filter</label>
                <select id="ageFilter" onchange="applyFilters()">
                    <option value="all">All Ages</option>
                    <option value="under18">Under 18</option>
                    <option value="18plus">18 and Older</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="groupFilter">Group</label>
                <select id="groupFilter" onchange="applyFilters()">
                    <option value="all">All Groups</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="positionFilter">Position</label>
                <select id="positionFilter" onchange="applyFilters()">
                    <option value="all">All Positions</option>
                </select>
            </div>
            
            <button class="reset-filters" onclick="resetFilters()">Reset Filters</button>
        </div>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by name, ID, etc..." onkeyup="if(event.key === 'Enter') applyFilters()">
            <button onclick="applyFilters()">Search</button>
        </div>
        
        <table id="criminalsTable">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Current Address</th>
                    <th>DOB</th>
                    <th>Group</th>
                    <th>Group Position</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="10" class="loading">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal for enlarged photo -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="Enlarged Photo">
            <span class="close-modal" onclick="closeModal()">Close</span>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7GeP3yxb0UJIPmE6e-PeA5V3CTK0mevc",
            authDomain: "gangsgallery.firebaseapp.com",
            databaseURL: "https://gangsgallery-default-rtdb.firebaseio.com",
            projectId: "gangsgallery",
            storageBucket: "gangsgallery.appspot.com",
            messagingSenderId: "622725528053",
            appId: "1:622725528053:web:cf27dab0632c51914208bc",
            measurementId: "G-3BWT2GWFZR"
        };

        // Initialize Firebase with all required services
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Global variables to store all criminals and unique groups/positions
        let allCriminals = [];
        let uniqueGroups = new Set();
        let uniquePositions = new Set();

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCriminals();
        });

        // Load criminals from Firebase
        function loadCriminals() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="10" class="loading">Loading data...</td></tr>';
            
            database.ref('criminals').once('value', (snapshot) => {
                const criminals = snapshot.val() || {};
                allCriminals = Object.entries(criminals).map(([key, value]) => ({ ...value, firebaseKey: key }));
                
                if (allCriminals.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No criminal records found</td></tr>';
                    return;
                }
                
                // Extract unique groups and positions
                uniqueGroups = new Set();
                uniquePositions = new Set();
                
                allCriminals.forEach(criminal => {
                    if (criminal.group) uniqueGroups.add(criminal.group);
                    if (criminal.groupPosition) uniquePositions.add(criminal.groupPosition);
                });
                
                // Populate group filter dropdown
                const groupFilter = document.getElementById('groupFilter');
                groupFilter.innerHTML = '<option value="all">All Groups</option>';
                uniqueGroups.forEach(group => {
                    groupFilter.innerHTML += `<option value="${group}">${group}</option>`;
                });
                
                // Populate position filter dropdown
                const positionFilter = document.getElementById('positionFilter');
                positionFilter.innerHTML = '<option value="all">All Positions</option>';
                uniquePositions.forEach(position => {
                    positionFilter.innerHTML += `<option value="${position}">${position}</option>`;
                });
                
                // Render the table with all data initially
                applyFilters();
            }).catch(error => {
                console.error("Error loading criminals:", error);
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #e74c3c;">Error loading data. Please try again.</td></tr>';
            });
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const ageFilter = document.getElementById('ageFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;
            const positionFilter = document.getElementById('positionFilter').value;
            
            const filtered = allCriminals.filter(criminal => {
                // Apply search filter
                const matchesSearch = 
                    !searchTerm || 
                    (criminal.name && criminal.name.toLowerCase().includes(searchTerm)) || 
                    (criminal.id && criminal.id.toLowerCase().includes(searchTerm)) ||
                    (criminal.group && criminal.group.toLowerCase().includes(searchTerm)) ||
                    (criminal.groupPosition && criminal.groupPosition.toLowerCase().includes(searchTerm));
                
                // Apply age filter
                const age = calculateAgeFromDOB(criminal.dob);
                let matchesAge = true;
                if (ageFilter === 'under18') {
                    matchesAge = age !== 'N/A' && age < 18;
                } else if (ageFilter === '18plus') {
                    matchesAge = age === 'N/A' || age >= 18;
                }
                
                // Apply group filter
                const matchesGroup = groupFilter === 'all' || criminal.group === groupFilter;
                
                // Apply position filter
                const matchesPosition = positionFilter === 'all' || criminal.groupPosition === positionFilter;
                
                return matchesSearch && matchesAge && matchesGroup && matchesPosition;
            });
            
            renderTable(filtered);
        }
        
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('ageFilter').value = 'all';
            document.getElementById('groupFilter').value = 'all';
            document.getElementById('positionFilter').value = 'all';
            applyFilters();
        }
        
        function renderTable(criminals) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            if (criminals.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No matching records found</td></tr>';
                return;
            }
            
            // Process each criminal record
            criminals.forEach(criminal => {
                const row = document.createElement('tr');
                const age = calculateAgeFromDOB(criminal.dob);
                
                // Create photo cell with click-to-enlarge functionality
                const photoCell = document.createElement('td');
                photoCell.className = 'photo-cell';
                
                const img = document.createElement('img');
                img.alt = criminal.name || 'Criminal photo';
                img.onclick = () => showEnlargedPhoto(criminal.image);
                
                // Set image source - handle both Firebase Storage URLs and regular URLs
                if (criminal.image) {
                    if (criminal.image.startsWith('gs://')) {
                        // Convert gs:// URL to download URL
                        const storageRef = storage.refFromURL(criminal.image);
                        storageRef.getDownloadURL().then(url => {
                            img.src = url;
                        }).catch(error => {
                            console.error("Error getting download URL:", error);
                            img.src = 'https://via.placeholder.com/60?text=No+Photo';
                        });
                    } else {
                        img.src = criminal.image || 'https://via.placeholder.com/60?text=No+Photo';
                    }
                } else {
                    img.src = 'https://via.placeholder.com/60?text=No+Photo';
                }
                
                photoCell.appendChild(img);
                
                // Create other cells
                const idCell = document.createElement('td');
                idCell.textContent = criminal.id || 'N/A';
                
                const nameCell = document.createElement('td');
                nameCell.textContent = criminal.name || 'N/A';
                
                const addressCell = document.createElement('td');
                addressCell.textContent = criminal.address || 'N/A';
                
                const currentAddressCell = document.createElement('td');
                currentAddressCell.textContent = criminal.currentAddress || 'N/A';
                
                const dobCell = document.createElement('td');
                dobCell.textContent = formatDate(criminal.dob);
                if (age !== 'N/A') {
                    const ageBadge = document.createElement('span');
                    ageBadge.className = 'age-badge';
                    ageBadge.textContent = age;
                    dobCell.appendChild(ageBadge);
                }
                
                const groupCell = document.createElement('td');
                groupCell.textContent = criminal.group || 'N/A';
                
                const positionCell = document.createElement('td');
                positionCell.textContent = criminal.groupPosition || 'N/A';
                
                const statusCell = document.createElement('td');
                statusCell.textContent = criminal.status || 'N/A';
                
                // Create action buttons cell
                const actionsCell = document.createElement('td');
                actionsCell.className = 'action-btns';
                
                const viewBtn = document.createElement('button');
                viewBtn.className = 'action-btn view-btn';
                viewBtn.textContent = 'View';
                viewBtn.onclick = () => viewCriminal(criminal.firebaseKey || criminal.id);
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editCriminal(criminal.firebaseKey || criminal.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteCriminal(criminal.firebaseKey || criminal.id);
                
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);
                
                // Append all cells to the row
                row.appendChild(photoCell);
                row.appendChild(idCell);
                row.appendChild(nameCell);
                row.appendChild(addressCell);
                row.appendChild(currentAddressCell);
                row.appendChild(dobCell);
                row.appendChild(groupCell);
                row.appendChild(positionCell);
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A';
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                return 'N/A';
            }
        }
        
        function calculateAgeFromDOB(dob) {
            if (!dob) return 'N/A';
            try {
                const birthDate = new Date(dob);
                if (isNaN(birthDate.getTime())) return 'N/A';
                
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age;
            } catch (e) {
                return 'N/A';
            }
        }
        
        function viewCriminal(id) {
            window.location.href = `criminal-form.html?view=${id}`;
        }
        
        function editCriminal(id) {
            window.location.href = `criminal-form.html?edit=${id}`;
        }
        
        function deleteCriminal(id) {
            if (confirm('Are you sure you want to delete this criminal record? This action cannot be undone.')) {
                // First check if we're using Firebase key or ID
                const criminalRef = id.startsWith('-') ? 
                    database.ref('criminals').child(id) : 
                    database.ref('criminals').orderByChild('id').equalTo(id);
                
                criminalRef.once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        let deletePromise;
                        
                        if (id.startsWith('-')) {
                            // Direct reference using Firebase key
                            deletePromise = database.ref('criminals').child(id).remove();
                        } else {
                            // Find by ID
                            snapshot.forEach(child => {
                                deletePromise = child.ref.remove();
                            });
                        }
                        
                        deletePromise.then(() => {
                            alert('Record deleted successfully');
                            loadCriminals(); // Reload data after deletion
                        }).catch(error => {
                            alert('Error deleting record: ' + error.message);
                            console.error("Delete error:", error);
                        });
                    } else {
                        alert('Record not found');
                    }
                });
            }
        }
        
        // Photo modal functions
        function showEnlargedPhoto(imageUrl) {
            if (!imageUrl) return;
            
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            
            // Handle Firebase Storage URLs
            if (imageUrl.startsWith('gs://')) {
                const storageRef = storage.refFromURL(imageUrl);
                storageRef.getDownloadURL().then(url => {
                    modalImg.src = url;
                    modal.style.display = 'flex';
                }).catch(error => {
                    console.error("Error getting download URL:", error);
                    alert('Could not load the photo');
                });
            } else {
                modalImg.src = imageUrl;
                modal.style.display = 'flex';
            }
        }
        
        function closeModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('photoModal');
            if (event.target === modal) {
                closeModal();
            }
        };
        
        // Export to PDF function with watermark
        async function exportToPDF() {
            // Show loading message
            const originalExportBtnText = document.querySelector('.export-btn').textContent;
            document.querySelector('.export-btn').textContent = 'Preparing PDF...';
            document.querySelector('.export-btn').disabled = true;
            
            try {
                // Get the current filtered data
                const tableBody = document.getElementById('tableBody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('td').colSpan === 10)) {
                    alert('No records to export');
                    return;
                }
                
                // Create PDF in landscape mode with custom dimensions
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Set document properties
                doc.setProperties({
                    title: 'Criminal Records Report',
                    subject: 'Criminal Records',
                    author: 'Criminal Records System',
                    keywords: 'criminal, records, report',
                    creator: 'Criminal Records System'
                });
                
                // Watermark settings
                const watermarkText = "Rapid Response & High Visibility Adducity";
                const watermarkFontSize = 12;
                const watermarkColor = [150, 150, 150]; // Light gray
                const watermarkOpacity = 0.2; // 20% opacity
                
                // Function to add watermark
                const addWatermark = () => {
                    doc.saveGraphicsState();
                    doc.setFontSize(watermarkFontSize);
                    doc.setTextColor(watermarkColor[0], watermarkColor[1], watermarkColor[2]);
                    doc.setGState(new doc.GState({ opacity: watermarkOpacity }));
                    
                    // Calculate position (top right)
                    const textWidth = doc.getTextWidth(watermarkText);
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const x = pageWidth - textWidth - 10; // 10mm from right edge
                    const y = 20; // 20mm from top
                    
                    doc.text(watermarkText, x, y);
                    doc.restoreGraphicsState();
                };
                
                // Title
                doc.setFontSize(18);
                doc.setTextColor(44, 62, 80);
                doc.text('Criminal Records', 14, 15);
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
                
                // Include filter info if any filter is active
                const ageFilter = document.getElementById('ageFilter').value;
                const groupFilter = document.getElementById('groupFilter').value;
                const positionFilter = document.getElementById('positionFilter').value;
                const searchTerm = document.getElementById('searchInput').value;
                
                let filterInfo = [];
                if (ageFilter !== 'all') filterInfo.push(`Age: ${ageFilter === 'under18' ? 'Under 18' : '18 and Older'}`);
                if (groupFilter !== 'all') filterInfo.push(`Group: ${groupFilter}`);
                if (positionFilter !== 'all') filterInfo.push(`Position: ${positionFilter}`);
                if (searchTerm) filterInfo.push(`Search: "${searchTerm}"`);
                
                if (filterInfo.length > 0) {
                    doc.text(`Filters: ${filterInfo.join(', ')}`, 14, 29);
                }
                
                // Prepare data for PDF including photos
                const pdfData = [];
                const photoPromises = [];
                
                for (const row of rows) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 10) {
                        const photoCell = cells[0];
                        const img = photoCell.querySelector('img');
                        const imgSrc = img ? img.src : '';
                        
                        photoPromises.push(
                            getImageData(imgSrc).then(imgData => {
                                const dobWithAge = cells[5].textContent.trim();
                                pdfData.push({
                                    photo: imgData,
                                    id: cells[1].textContent.trim(),
                                    name: cells[2].textContent.trim(),
                                    address: cells[3].textContent.trim(),
                                    currentAddress: cells[4].textContent.trim(),
                                    dob: dobWithAge,
                                    group: cells[6].textContent.trim(),
                                    groupPosition: cells[7].textContent.trim(),
                                    status: cells[8].textContent.trim()
                                });
                            }).catch(error => {
                                console.error("Error processing image:", error);
                                const dobWithAge = cells[5].textContent.trim();
                                pdfData.push({
                                    photo: null,
                                    id: cells[1].textContent.trim(),
                                    name: cells[2].textContent.trim(),
                                    address: cells[3].textContent.trim(),
                                    currentAddress: cells[4].textContent.trim(),
                                    dob: dobWithAge,
                                    group: cells[6].textContent.trim(),
                                    groupPosition: cells[7].textContent.trim(),
                                    status: cells[8].textContent.trim()
                                });
                            })
                        );
                    }
                }
                
                // Wait for all images to be processed
                await Promise.all(photoPromises);
                
                // Define columns for the PDF table
                const columns = [
                    { 
                        header: 'Photo', 
                        dataKey: 'photo',
                        renderCell: function(cellData) {
                            return cellData || 'No Photo';
                        }
                    },
                    { header: 'ID', dataKey: 'id' },
                    { header: 'Name', dataKey: 'name' },
                    { header: 'Address', dataKey: 'address' },
                    { header: 'Current Address', dataKey: 'currentAddress' },
                    { header: 'DOB (Age)', dataKey: 'dob' },
                    { header: 'Group', dataKey: 'group' },
                    { header: 'Position', dataKey: 'groupPosition' },
                    { header: 'Status', dataKey: 'status' }
                ];
                
                // Calculate column widths based on page size
                const pageWidth = 297; // A4 landscape width in mm
                const margins = 14 * 2;
                const availableWidth = pageWidth - margins;
                
                const columnRatios = {
                    photo: 0.08,
                    id: 0.07,
                    name: 0.12,
                    address: 0.15,
                    currentAddress: 0.15,
                    dob: 0.1,
                    group: 0.1,
                    groupPosition: 0.1,
                    status: 0.08
                };
                
                const columnStyles = {};
                Object.keys(columnRatios).forEach((key, index) => {
                    columnStyles[index] = { cellWidth: availableWidth * columnRatios[key] };
                });
                
                // Add watermark to first page
                addWatermark();
                
                // Add table to PDF
                doc.autoTable({
                    head: [columns.map(col => col.header)],
                    body: pdfData.map(row => {
                        return columns.map(col => {
                            if (col.dataKey === 'photo') {
                                return row[col.dataKey] || 'No Photo';
                            }
                            return row[col.dataKey] || 'N/A';
                        });
                    }),
                    startY: filterInfo.length > 0 ? 36 : 28,
                    margin: { left: 14, right: 14 },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        overflow: 'linebreak',
                        minCellHeight: 15,
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [44, 62, 80],
                        textColor: 255,
                        fontSize: 9,
                        valign: 'middle'
                    },
                    bodyStyles: {
                        valign: 'middle'
                    },
                    columnStyles: columnStyles,
                    didParseCell: function(data) {
                        if (data.column.index === 0 && data.cell.raw && typeof data.cell.raw === 'object') {
                            data.cell.text = '';
                        }
                    },
                    didDrawCell: function(data) {
                        if (data.column.index === 0 && data.cell.raw && typeof data.cell.raw === 'object') {
                            const imgData = data.cell.raw;
                            try {
                                const maxWidth = data.cell.width - 2;
                                const maxHeight = data.cell.height - 2;
                                
                                let imgWidth = imgData.width;
                                let imgHeight = imgData.height;
                                
                                const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
                                imgWidth *= ratio;
                                imgHeight *= ratio;
                                
                                const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                                const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                                
                                doc.addImage(
                                    imgData.content,
                                    'JPEG',
                                    x,
                                    y,
                                    imgWidth,
                                    imgHeight
                                );
                            } catch (e) {
                                console.error("Error adding image to PDF:", e);
                                doc.text('Image Error', data.cell.x + 5, data.cell.y + 10);
                            }
                        }
                    },
                    didDrawPage: function(data) {
                        // Add watermark to subsequent pages
                        if (data.pageNumber > 1) {
                            addWatermark();
                        }
                        
                        // Add page number
                        doc.setFontSize(10);
                        doc.setTextColor(100);
                        const pageCount = doc.internal.getNumberOfPages();
                        doc.text(`Page ${data.pageNumber} of ${pageCount}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 10);
                    }
                });
                
                // Save the PDF
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                doc.save(`criminal_records_${timestamp}.pdf`);
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert('Error generating PDF: ' + error.message);
            } finally {
                // Restore export button
                document.querySelector('.export-btn').textContent = originalExportBtnText;
                document.querySelector('.export-btn').disabled = false;
            }
        }

        // Helper function to get image data for PDF
        function getImageData(url) {
            return new Promise((resolve, reject) => {
                if (!url || url.includes('placeholder.com')) {
                    reject('No valid image URL');
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                
                // Set timeout for image loading
                const timeout = setTimeout(() => {
                    img.onload = img.onerror = null;
                    reject('Image loading timed out');
                }, 5000);
                
                img.onload = function() {
                    clearTimeout(timeout);
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas dimensions to image dimensions
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Draw image on canvas
                        ctx.drawImage(img, 0, 0);
                        
                        // Convert to data URL with reduced quality for smaller PDF size
                        const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                        resolve({
                            content: dataURL,
                            width: img.width,
                            height: img.height
                        });
                    } catch (e) {
                        reject('Error processing image: ' + e.message);
                    }
                };
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    reject('Failed to load image');
                };
                
                img.src = url;
            });
        }
    </script>
</body>
</html>